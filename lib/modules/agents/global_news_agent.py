from dataclasses import dataclass
from datetime import datetime
from textwrap import dedent
from typing import List
from lib.adapter.llm import get_llm
from lib.adapter.llm.interface import LlmAbstract
from lib.modules import get_agent
from lib.modules.news_proxy import news_proxy
from lib.modules.agents.web_page_reader import WebPageReader
from lib.tools.cache_decorator import use_cache
from lib.tools.information_search import unified_search
from lib.utils.news import render_news_in_markdown_group_by_platform

# å…¨å±€ç³»ç»Ÿæç¤ºè¯
GLOBAL_NEWS_SYSTEM_PROMPT_TEMPLATE = """
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„é‡‘èåˆ†æå¸ˆï¼Œæ“…é•¿åˆ†æå…¨çƒå¸‚åœºæ–°é—»å’Œå®è§‚ç»æµä¿¡æ¯ã€‚
"""

# å…¨å±€æœç´¢æç¤ºè¯
# ä½¿ç”¨å°å‚æ•°æ¨¡å‹ï¼Œæ¯”å¦‚QwQ-32Bç­‰ï¼Œå·¥å…·è°ƒç”¨èƒ½åŠ›å¾ˆå¼±ï¼šåªæœ‰reasoningï¼Œæ²¡æœ‰tool_use
# ä½¿ç”¨ï¼šqwen3-235b-a22bï¼Œæ¯æ¬¡åˆåªä¼šè°ƒç”¨ä¸€æ¬¡
GLOBAL_NEWS_SEARCH_PROMPT_TEMPLATE = """
è¯·é«˜æ•ˆåœ°æœç´¢å’Œæ”¶é›†æœ€æ–°çš„å¸‚åœºæ–°é—»ä¿¡æ¯ã€‚**é‡è¦ï¼šä½ å¯ä»¥åŒæ—¶è°ƒç”¨å¤šä¸ªå·¥å…·æ¥æé«˜æ•ˆç‡ï¼**

**æœç´¢ç­–ç•¥ï¼š**

**ç¬¬ä¸€é˜¶æ®µï¼šæ‰¹é‡æœç´¢æ ¸å¿ƒå…³é”®è¯å’ŒæŸ¥è¯¢å„å¹³å°çƒ­æœ**
è¯·**åŒæ—¶**æœç´¢ä»¥ä¸‹å…³é”®è¯ï¼Œä¸è¦ä¸€ä¸ªä¸€ä¸ªæ¥ï¼Œæ¯æ¬¡æœç´¢ååˆ†æç»“æœè´¨é‡ï¼š

1. **å…¨çƒå®è§‚ç»æµ**ï¼ˆè‹±æ–‡æœç´¢ï¼Œregion="us-en"ï¼‰å…³é”®è¯ç¤ºä¾‹ï¼š
   - "Fed policy" (ç¾è”å‚¨æ”¿ç­–)
   - "inflation data" (é€šèƒ€æ•°æ®)
   - "interest rates" (åˆ©ç‡)
   - "GDP growth" (GDPå¢é•¿)

2. **ç¾å›½ç»æµæ•°æ®**ï¼ˆè‹±æ–‡æœç´¢ï¼Œregion="us-en"ï¼‰å…³é”®è¯ç¤ºä¾‹ï¼š
   - "employment report" (å°±ä¸šæŠ¥å‘Š)
   - "CPI data" (CPIæ•°æ®)
   - "consumer confidence" (æ¶ˆè´¹è€…ä¿¡å¿ƒ)

3. **åŠ å¯†è´§å¸**ï¼ˆè‹±æ–‡æœç´¢ï¼Œregion="us-en"ï¼‰å…³é”®è¯ç¤ºä¾‹ï¼š
   - "Bitcoin price" (æ¯”ç‰¹å¸ä»·æ ¼)
   - "crypto regulation" (åŠ å¯†è´§å¸ç›‘ç®¡)

4. **ä¸­å›½å¸‚åœº**ï¼ˆä¸­æ–‡æœç´¢ï¼Œregion="zh-cn"ï¼‰å…³é”®è¯ç¤ºä¾‹ï¼š
   - "ä¸­å›½è‚¡å¸‚æ”¿ç­–" (ä¸­å›½è‚¡å¸‚æ”¿ç­–)
   - "æ–°èƒ½æºæ±½è½¦" (æ–°èƒ½æºæ±½è½¦)
   - "ä¸­å›½GDPæ•°æ®" (ä¸­å›½GDPæ•°æ®)
   - "PMIæŒ‡æ•°" (PMIæŒ‡æ•°)

5. **å…¨çƒå¸‚åœº**ï¼ˆè‹±æ–‡æœç´¢ï¼Œregion="us-en"ï¼‰å…³é”®è¯ç¤ºä¾‹ï¼š
   - "US stocks" (ç¾å›½è‚¡å¸‚)
   - "oil prices" (çŸ³æ²¹ä»·æ ¼)
   - "gold trend" (é»„é‡‘è¶‹åŠ¿)

6. **å…¨çƒçƒ­æœ**ï¼ˆä½¿ç”¨å„å¤§å¹³å°çš„çƒ­æœæŸ¥è¯¢å·¥å…·ï¼‰ï¼š

**ç¬¬äºŒé˜¶æ®µï¼šç»“æœè¯„ä¼°å’Œæ·±åº¦è·å–**
æ¯æ¬¡æœç´¢åï¼Œè¯·è¯„ä¼°ï¼š
1. **ä¿¡æ¯å®Œæ•´æ€§**ï¼šæ–°é—»æè¿°æ˜¯å¦å®Œæ•´ï¼Œæ˜¯å¦åŒ…å«å…³é”®æ•°æ®
2. **é‡è¦æ€§è¯„çº§**ï¼šæ˜¯å¦æ¶‰åŠé‡å¤§æ”¿ç­–å˜åŒ–æˆ–å¸‚åœºäº‹ä»¶
3. **æ˜¯å¦éœ€è¦æ·±åº¦é˜…è¯»**ï¼šå¯¹äºä»¥ä¸‹æƒ…å†µï¼Œä½¿ç”¨`_read_web_page`è·å–å®Œæ•´å†…å®¹ï¼š
   - æ–°é—»æ ‡é¢˜é‡è¦ä½†æè¿°è¿‡äºç®€çŸ­
   - æ¶‰åŠå…·ä½“ç»æµæ•°æ®æˆ–æ”¿ç­–ç»†èŠ‚
   - å¯èƒ½å¯¹å¸‚åœºäº§ç”Ÿé‡å¤§å½±å“çš„æ–°é—»

**ç¬¬ä¸‰é˜¶æ®µï¼šè¡¥å……æœç´¢**
æ ¹æ®å‰é¢æœç´¢ç»“æœçš„åˆ†æï¼Œå¦‚æœå‘ç°æŸäº›é‡è¦é¢†åŸŸä¿¡æ¯ä¸è¶³ï¼Œè¯·ï¼š
1. è°ƒæ•´å…³é”®è¯é‡æ–°æœç´¢
2. ä½¿ç”¨æ›´å…·ä½“çš„å…³é”®è¯
3. å˜æ¢æœç´¢åŒºåŸŸ

**æœç´¢æ‰§è¡ŒæŒ‡å¯¼ï¼š**
- **å¼€å§‹æœç´¢**ï¼šå…³é”®è¯æœç´¢å¼€å§‹ï¼ŒåŒæ—¶å‘èµ·å¤šä¸ªæœç´¢å·¥å…·è°ƒç”¨
- **åˆ†æç»“æœ**ï¼šæŸ¥çœ‹æœç´¢ç»“æœçš„è´¨é‡å’Œç›¸å…³æ€§
- **å†³å®šä¸‹ä¸€æ­¥**ï¼š
  - å¦‚æœç»“æœå¥½ä¸”ä¿¡æ¯å®Œæ•´ï¼šç›´æ¥è¾“å‡ºæŠ¥å‘Š
  - å¦‚æœæœ‰é‡è¦ä½†ä¿¡æ¯ä¸å®Œæ•´çš„æ–°é—»ï¼šä½¿ç”¨`_read_web_page(url)`è·å–è¯¦ç»†å†…å®¹
  - å¦‚æœç»“æœä¸ç†æƒ³ï¼šè°ƒæ•´å…³é”®è¯é‡æ–°æœç´¢
- **ç»§ç»­å¾ªç¯**ï¼šé‡å¤ä¸Šè¿°è¿‡ç¨‹ï¼Œç›´åˆ°è¦†ç›–æ‰€æœ‰é‡è¦å¸‚åœºé¢†åŸŸ

**é‡è¦è¦æ±‚ï¼š**
1. **å¹¶è¡Œæ‰§è¡Œ**ï¼šä¸€æ¬¡æ€§å‘èµ·å¤šä¸ªç›¸äº’ç‹¬ç«‹çš„æœç´¢å·¥å…·è°ƒç”¨è¯·æ±‚ï¼Œæé«˜æ•ˆç‡
2. **æ·±åº¦è·å–**ï¼šå¯¹é‡è¦æ–°é—»å¿…é¡»è·å–å®Œæ•´å†…å®¹
3. **çµæ´»è°ƒæ•´**ï¼šæ ¹æ®æœç´¢ç»“æœåŠ¨æ€è°ƒæ•´ç­–ç•¥

**ä½¿ç”¨å·¥å…·è¯´æ˜ï¼š**
- `_search_tool(query, region)`ï¼šæœç´¢æ–°é—»ï¼Œä¸€æ¬¡åªæœç´¢ä¸€ä¸ªå…³é”®è¯
- `_read_web_page(url)`ï¼šè·å–é‡è¦æ–°é—»çš„å®Œæ•´å†…å®¹
- `_get_top_10_hot_news_of_platform(platforms, top_k)`ï¼šè·å–å„å¤§å¹³å°çš„çƒ­æœ

**æœ€ç»ˆè¾“å‡ºè¦æ±‚ï¼š**
æœç´¢å®Œæˆåï¼Œè¯·åˆ†æè¿™äº›æ–°é—»ä¿¡æ¯å¹¶æä¾›ä¸€ä»½æŠ¥å‘Šï¼Œå‚è€ƒæ¨¡æ¿å¦‚ä¸‹ï¼š

## ğŸ“Š å¸‚åœºåˆ†ææŠ¥å‘Š

### ğŸŒ å…¨çƒå®è§‚ç»æµåŠ¨æ€
- **ä¸»è¦ç»æµæ”¿ç­–å˜åŒ–**ï¼šå¤®è¡Œæ”¿ç­–ã€åˆ©ç‡è°ƒæ•´ã€è´¢æ”¿æ”¿ç­–
- **é€šèƒ€å’Œç»æµæ•°æ®**ï¼šCPIã€GDPã€å°±ä¸šæ•°æ®ç­‰å…³é”®æŒ‡æ ‡
- **åœ°ç¼˜æ”¿æ²»å½±å“**ï¼šå›½é™…å†²çªã€è´¸æ˜“æ”¿ç­–å¯¹å¸‚åœºçš„å½±å“

### ğŸ“ˆ ç»Ÿè®¡æ•°æ®è§£è¯»
- **ä¸­å›½ç»Ÿè®¡æ•°æ®**ï¼šæœ€æ–°å‘å¸ƒçš„GDPã€CPIã€PMIã€å·¥ä¸šå¢åŠ å€¼ç­‰æ•°æ®è§£è¯»
- **ç¾å›½ç»Ÿè®¡æ•°æ®**ï¼šæœ€æ–°å‘å¸ƒçš„å°±ä¸šæŠ¥å‘Šã€é€šèƒ€æ•°æ®ã€æ¶ˆè´¹è€…ä¿¡å¿ƒç­‰æ•°æ®è§£è¯»
- **æ•°æ®å½±å“åˆ†æ**ï¼šç»Ÿè®¡æ•°æ®å¯¹å¸‚åœºè¶‹åŠ¿å’Œæ”¿ç­–èµ°å‘çš„æŒ‡ç¤ºæ„ä¹‰

### ğŸ’° åŠ å¯†è´§å¸å¸‚åœºåˆ†æ
- **æ¯”ç‰¹å¸å’Œä¸»æµå¸åŠ¨æ€**ï¼šä»·æ ¼è¶‹åŠ¿ã€æŠ€æœ¯å‘å±•ã€å¸‚åœºæƒ…ç»ª
- **ç›‘ç®¡æ”¿ç­–å½±å“**ï¼šå„å›½å¯¹åŠ å¯†è´§å¸çš„æœ€æ–°æ”¿ç­–å’Œç›‘ç®¡åŠ¨å‘
- **æœºæ„æŠ•èµ„è¶‹åŠ¿**ï¼šå¤§å‹æœºæ„å’Œå…¬å¸çš„åŠ å¯†è´§å¸æŠ•èµ„åŠ¨æ€

### ğŸ‡¨ğŸ‡³ Aè‚¡å’Œä¸­å›½å¸‚åœº
- **æ”¿ç­–å¯¼å‘**ï¼šæ”¿åºœæ”¿ç­–å¯¹è‚¡å¸‚çš„å½±å“å’Œè¡Œä¸šæ‰¶æŒæ”¿ç­–
- **é‡è¦æ¿å—åŠ¨æ€**ï¼šç§‘æŠ€ã€æ–°èƒ½æºã€åŒ»è¯ç­‰é‡ç‚¹è¡Œä¸šæ–°é—»
- **å®è§‚ç»æµæ•°æ®**ï¼šä¸­å›½GDPã€åˆ¶é€ ä¸šPMIç­‰ç»æµæŒ‡æ ‡

### ğŸŒ å…¨çƒå¸‚åœºè”åŠ¨
- **ä¸»è¦è‚¡æŒ‡è¡¨ç°**ï¼šç¾è‚¡ã€æ¬§è‚¡ã€äºšå¤ªè‚¡å¸‚çš„è¡¨ç°å’Œç›¸äº’å½±å“
- **å¤§å®—å•†å“èµ°åŠ¿**ï¼šçŸ³æ²¹ã€é»„é‡‘ã€è´µé‡‘å±ç­‰ä»·æ ¼å˜åŒ–
- **è´§å¸æ±‡ç‡å½±å“**ï¼šä¸»è¦è´§å¸å¯¹çš„èµ°åŠ¿å¯¹å„å¸‚åœºçš„å½±å“

### âš ï¸ æŠ•èµ„é£é™©å’Œæœºä¼šæç¤º

#### ğŸ”´ ä¸»è¦é£é™©æç¤º
- **å®è§‚é£é™©**ï¼šæ”¿ç­–å˜åŒ–ã€é€šèƒ€å‹åŠ›ã€åˆ©ç‡é£é™©ç­‰ç³»ç»Ÿæ€§é£é™©
- **åœ°ç¼˜æ”¿æ²»é£é™©**ï¼šå›½é™…å†²çªã€è´¸æ˜“æ‘©æ“¦å¯¹å¸‚åœºçš„å†²å‡»é£é™©
- **è¡Œä¸šé£é™©**ï¼šç‰¹å®šè¡Œä¸šé¢ä¸´çš„ç›‘ç®¡ã€æŠ€æœ¯æˆ–ç«äº‰é£é™©
- **æµåŠ¨æ€§é£é™©**ï¼šå¸‚åœºæµåŠ¨æ€§ç´§å¼ å¯èƒ½å¸¦æ¥çš„é£é™©

#### ğŸŸ¢ æ½œåœ¨æŠ•èµ„æœºä¼š
- **æ”¿ç­–çº¢åˆ©**ï¼šå—ç›Šäºæ”¿ç­–æ‰¶æŒçš„è¡Œä¸šå’Œä¸»é¢˜æŠ•èµ„æœºä¼š
- **æŠ€æœ¯åˆ›æ–°**ï¼šæ–°æŠ€æœ¯çªç ´å¸¦æ¥çš„æŠ•èµ„æœºä¼š
- **ä¼°å€¼ä¿®å¤**ï¼šè¢«é”™æ€æˆ–ä½ä¼°çš„ä¼˜è´¨èµ„äº§æŠ•èµ„æœºä¼š
- **å‘¨æœŸæ€§æœºä¼š**ï¼šåŸºäºç»æµå‘¨æœŸçš„èµ„äº§é…ç½®æœºä¼š

### ğŸ“š ä¿¡æ¯æ¥æº
æœ¬æŠ¥å‘Šä¸­çš„æ‰€æœ‰ä¿¡æ¯å‡æ¥è‡ªä»¥ä¸‹å…·ä½“æ–°é—»æ–‡ç« ï¼ˆè¯·åˆ—å‡ºæ‰€æœ‰å¼•ç”¨çš„å…·ä½“æ–‡ç« é“¾æ¥ï¼‰ï¼š
- [åœ¨æ­¤åˆ—å‡ºæ‰€æœ‰å¼•ç”¨çš„å…·ä½“æ–°é—»æ–‡ç« æ ‡é¢˜å’Œé“¾æ¥]

**å…³é”®ä¿¡æ¯æ¥æºæ ‡æ³¨è¦æ±‚ï¼š**
1. **å¿…é¡»ä½¿ç”¨æœç´¢ç»“æœä¸­çš„å…·ä½“æ–‡ç« URL**ï¼Œè€Œä¸æ˜¯ç½‘ç«™é¦–é¡µé“¾æ¥
2. **æ¯æ¡é‡è¦ä¿¡æ¯éƒ½è¦ç”¨ [æ–‡ç« æ ‡é¢˜](å…·ä½“æ–‡ç« URL) æ ¼å¼æ ‡æ³¨æ¥æº**
3. **ç¤ºä¾‹æ ¼å¼**ï¼šæ ¹æ® [ç¾è”å‚¨å®£å¸ƒç»´æŒåˆ©ç‡ä¸å˜ï¼Œå¸‚åœºé¢„æœŸä¸‹æ¬¡ä¼šè®®æˆ–åŠ æ¯](https://www.example.com/fed-rate-decision-2024-07-17) çš„æŠ¥é“...
4. **å¦‚æœåŒä¸€ä¿¡æ¯æœ‰å¤šä¸ªæ¥æºï¼Œé€‰æ‹©æœ€æƒå¨æˆ–æœ€æ–°çš„æ–‡ç« é“¾æ¥**
5. **åœ¨ä¿¡æ¯æ¥æºç« èŠ‚ä¸­ï¼ŒæŒ‰ç±»åˆ«æ•´ç†æ‰€æœ‰å¼•ç”¨çš„æ–‡ç« é“¾æ¥**
6. **ç¡®ä¿æ¯ä¸ªé“¾æ¥éƒ½æ˜¯å¯è®¿é—®çš„å…·ä½“æ–°é—»æ–‡ç« é¡µé¢**
7. **å¯¹äºé€šè¿‡ç½‘é¡µè¯»å–å·¥å…·è·å–çš„è¯¦ç»†å†…å®¹ï¼Œç‰¹åˆ«æ ‡æ³¨"è¯¦ç»†å†…å®¹æ¥æº"**

**å¦‚æœæœç´¢ç»“æœä¸­æ²¡æœ‰æä¾›å…·ä½“çš„æ–‡ç« é“¾æ¥ï¼Œè¯·åœ¨æŠ¥å‘Šä¸­æ˜ç¡®è¯´æ˜ï¼š"éƒ¨åˆ†ä¿¡æ¯æ¥æºæ— æ³•æä¾›å…·ä½“é“¾æ¥"**
"""


def cache_key_generator(kwargs: dict, *args) -> str:
    """
    ç”Ÿæˆç¼“å­˜é”®ï¼Œåªè¦from_timeçš„å¹´æœˆæ—¥ç›¸åŒå°±å‘½ä¸­ç¼“å­˜
    """
    from_time: datetime = datetime.now()
    date_str = from_time.strftime("%Y-%m-%d")
    return f"global_news_report:{date_str}"

@dataclass
class GlobalNewsAgent:
    """
    å…¨çƒæ–°é—»æŠ¥å‘Šç”Ÿæˆå™¨ï¼Œä¸“é—¨è´Ÿè´£ç”Ÿæˆå…¨çƒæ–°é—»å’Œå®è§‚ç»æµä¿¡æ¯çš„åˆ†ææŠ¥å‘Š
    """
    _llm: LlmAbstract

    def __init__(
            self, 
            llm: LlmAbstract = None,
            web_page_reader: WebPageReader = None,
        ):
        self._llm = llm or get_llm("paoluz", "gpt-4o-mini", temperature=0.2)
        self._web_page_reader = web_page_reader or WebPageReader(llm=self._llm)
        self._agent = get_agent(llm=self._llm)
        self._agent.set_system_prompt(GLOBAL_NEWS_SYSTEM_PROMPT_TEMPLATE)
        self._agent.register_tool(self._search_tool)
        self._agent.register_tool(self._read_web_page)
        self._agent.register_tool(self._get_top_10_hot_news_of_platform)

    def _get_top_10_hot_news_of_platform(self, platforms: List[str], top_k: int = 5) -> str:

        """
        è·å–æŒ‡å®šå¹³å°çš„å‰top_kæ¡çƒ­é—¨æ–°é—»
        Args:
            platforms: å­—ç¬¦ä¸²æ•°ç»„ï¼Œæ–°é—»å¹³å°åç§°åˆ—è¡¨, ä¾‹å¦‚"36kr", "qq-news", "sina-news", "sina", "huxiu", "netease-news", "toutiao"
            top_k: æ¯ä¸ªå¹³å°è¿”å›çš„çƒ­é—¨æ–°é—»æ•°é‡ï¼Œé»˜è®¤ä¸º5

        Returns:
            è¿”å›æ ¼å¼åŒ–çš„æ–°é—»åˆ—è¡¨å­—ç¬¦ä¸²
        """
        result = {}
        for platform in platforms:
            result[platform] = news_proxy.get_current_hot_news(platform)[:top_k]
        return render_news_in_markdown_group_by_platform(result)

    def _read_web_page(self, url: str) -> str:
        """
        è¯»å–ç½‘é¡µå†…å®¹å¹¶è¿”å›æ ¼å¼åŒ–çš„æ–°é—»åˆ—è¡¨å­—ç¬¦ä¸²
        Args:
            url: ç½‘é¡µURL

        Returns:
            è¿”å›æ ¼å¼åŒ–çš„æ–°é—»åˆ—è¡¨å­—ç¬¦ä¸²
        """
        return self._web_page_reader.read_and_summary(url)

    def _search_tool(self, query: str, region: str) -> str:
        """
        æ ¹æ®å…³é”®è¯ä½¿ç”¨æœç´¢å¼•æ“æœç´¢ä¸€å¤©èŒƒå›´å†…çš„æœ€æ–°æ–°é—»ï¼Œå¹¶è¿”å›æ ¼å¼åŒ–çš„æ–°é—»åˆ—è¡¨å­—ç¬¦ä¸²ã€‚
        Args:
            query: æœç´¢æŸ¥è¯¢å­—ç¬¦ä¸²
            region: æœç´¢åŒºåŸŸå­—ç¬¦ä¸², ä¾‹å¦‚ "zh-cn" è¡¨ç¤ºä¸­æ–‡åŒºåŸŸ, "en-us" è¡¨ç¤ºç¾å›½è‹±è¯­åŒºåŸŸç­‰

        Returns:
            è¿”å›æ ¼å¼åŒ–çš„æ–°é—»åˆ—è¡¨å­—ç¬¦ä¸²
        """
        return render_news_in_markdown_group_by_platform({
            "GoogleSearch": unified_search(
                query, 
                time_limit="d", 
                max_results=10,
                region=region
            )
        })
    
    @use_cache(86400, use_db_cache=True, key_generator=cache_key_generator)
    def get_recent_global_news_report(self) -> str:
        """
        è·å–å…¨çƒæ–°é—»å’Œå®è§‚ç»æµä¿¡æ¯
        """
        # æ„å»ºæœç´¢æç¤º
        return self._agent.ask(GLOBAL_NEWS_SEARCH_PROMPT_TEMPLATE, tool_use=True)

__all__ = ["GlobalNewsAgent"]