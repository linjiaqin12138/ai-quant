# 2025-7-16-Python项目设计最佳实践总结

## 问题背景

在Python项目开发过程中，遇到了多个关于代码设计和架构的关键问题：
1. 如何选择合适的数据结构定义方式（TypedDict vs dataclass）
2. 如何合理规划项目中的model和临时数据结构
3. API设计中参数和返回值的最佳实践
4. 异常处理机制的设计原则

这些问题直接影响代码的可维护性、可读性和项目的长期发展。

## 解决方案与最佳实践

### 1. TypedDict vs dataclass 选择指南

**TypedDict 适用场景：**
- 与第三方库（pandas、json等）交互，数据本身就是字典结构
- 用于类型标注API返回值、json数据、pandas DataFrame行
- 字段较多且不需要方法和行为的场景
- 数据来源不确定、字段可能缺失的情况

**dataclass 适用场景：**
- 需要面向对象操作的业务模型
- 支持点操作访问属性（`obj.field`）
- 需要对象行为、属性访问、数据封装的场景
- 字段固定、结构清晰的业务实体

**著名开源项目例子：**
- mypy、pandas-stubs：大量使用TypedDict标注dict结构数据
- FastAPI、scikit-learn：使用dataclass定义业务模型和参数对象

### 2. 项目model和临时数据结构规划

**业务模型（lib/model/目录）：**
- 长期稳定、核心的数据结构
- 与业务实体、领域对象、核心流程相关
- 优先使用dataclass，需要与外部数据交互时考虑TypedDict
- 采用大驼峰命名，体现业务含义

**临时/局部数据结构：**
- 仅在函数、模块内部短期使用
- 直接定义在使用处，不放入model目录
- 优先用TypedDict或NamedTuple
- 以`_`开头或加`Temp`、`Helper`后缀

**迁移与演进：**
- 临时结构变为通用稳定时，迁移到lib/model/并规范命名
- model目录下的结构只在局部使用时，下沉到具体模块

### 3. API参数设计最佳实践

**核心原则：**
- 参数命名清晰、语义明确（避免缩写和歧义）
- 参数顺序合理（必选在前，可选在后）
- 为可选参数设置合理默认值
- 明确的类型注解
- 完整的参数校验
- 避免参数过多（封装为对象）
- 详细的docstring文档
- 保持向后兼容性
- 避免可变类型作为默认参数
- 全项目统一的命名风格

### 4. API返回值设计最佳实践

**核心原则：**
- 返回结构化数据（dict、dataclass、Pydantic模型）
- 明确字段含义，避免魔法顺序
- 统一返回格式（如code、msg、data字段）
- 保持兼容性与可扩展性
- 错误处理友好（明确错误码和信息）

**著名项目参考：**
- FastAPI：使用Pydantic模型定义返回结构
- requests：提供具名属性访问（status_code、json()）
- GitHub REST API：返回可扩展的json对象

### 5. 异常处理设计原则

**核心设计理念：**
- 业务层遇到不合法情况直接raise定制异常
- 接口层统一try-catch，避免业务流程中大量异常处理
- 使用单一异常类型，通过code字段区分错误类型
- 在最外层捕获非项目异常，包装为unknown error

**实现方案：**
```python
class ProjectError(Exception):
    def __init__(self, code: str, message: str):
        self.code = code
        self.message = message
        super().__init__(f"[{code}] {message}")

# 业务层直接抛出异常
def business_logic():
    if invalid_condition:
        raise ProjectError("INVALID_INPUT", "具体错误信息")

# 最外层统一处理
def main():
    try:
        business_logic()
    except ProjectError as e:
        handle_business_error(e.code, e.message)
    except Exception as e:
        handle_unknown_error(str(e))
```

## 经验总结

### 设计思路
1. **分层清晰**：业务层专注逻辑，接口层处理交互，避免职责混淆
2. **统一标准**：全项目保持一致的命名、结构、错误处理风格
3. **面向未来**：考虑扩展性和向后兼容性，避免过度设计
4. **文档先行**：清晰的类型注解和docstring是代码自文档化的基础

### 沟通要点
- 在讨论技术选型时，结合具体使用场景和项目特点
- 通过著名开源项目的实际案例来验证设计思路
- 保持代码风格的一致性比追求完美更重要
- 异常处理要兼顾代码简洁性和错误信息的完整性

### 后续注意事项
1. 在项目实践中验证这些设计原则的有效性
2. 根据项目发展调整model结构的组织方式
3. 建立代码review机制，确保设计原则的执行
4. 定期重构，保持代码质量和架构清晰度

## 参考资料
- FastAPI官方文档
- mypy项目源码
- Python官方typing文档
- 各大开源项目的API设计实践