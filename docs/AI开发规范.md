# AI开发规范

## 代码风格与结构规范

### 1. 代码复用原则
- **优先使用项目现有的工具函数**：开发新功能时，首先检查`lib.utils`中是否已有相关工具函数
- **保持代码一致性**：遵循项目现有的代码风格和实现方案，参考同一文件夹下其他模块的代码
- **避免重复造轮子**：如使用`lib.utils.string.hash_str()`而不是重新实现哈希函数

### 2. 错误处理规范
- **透明错误处理**：不要随意捕获和隐藏异常，让错误"大大方方地抛出"
- **区分错误类型**：
  - 网络相关错误（ConnectionError, TimeoutError, OSError, RatelimitException）→ 使用重试机制
  - 其他错误 → 直接抛出，不要隐藏
- **使用装饰器处理重试**：使用`@with_retry`装饰器处理网络问题，而不是try-catch
- **记录重试日志**：使用项目统一的日志记录方式记录重试信息

### 3. 函数设计规范
- **单一职责原则**：每个函数应该只做一件事
- **明确的输入输出**：使用类型注解明确参数和返回值类型
- **合理的默认参数**：为可选参数提供合理的默认值
- **完整的文档字符串**：包含功能描述、参数说明、返回值说明和使用示例

## 项目结构规范

### 1. 目录结构规范
- `lib/utils/`: 通用工具函数，**不具有副作用**
- `lib/tools/`: 通用工具函数，**具有副作用**（如网络请求、文件操作）
- `lib/adapter/`: 适配器层，统一不同API或数据源的接口
- `lib/model/`: 数据结构和业务模型
- `lib/modules/`: 复杂功能模块，整合其他组件
- `test/`: pytest测试用例

### 2. 导入规范
- 按照层次结构导入：标准库 → 第三方库 → 项目内部模块
- 使用相对导入引用项目内部模块
- 导入项目工具函数时优先使用`lib.utils`中的函数

## 开发流程规范

### 1. 测试驱动开发
- **编写全面的测试用例**：包括正常流程、边界情况和异常情况
- **禁止“脱裤子放屁”式测试用例**：不要编写无实际意义、仅为测试覆盖而覆盖、对功能无实际验证价值的测试用例（如仅调用函数但不做断言、不验证结果的测试）。
    - 典型例子：
        - 仅调用函数但没有任何断言或结果校验的测试用例。
        - 测试内容与实际业务无关，仅为提高覆盖率而随意调用接口。
        - 对返回值不做任何检查，或者断言永远为真的表达式（如assert True）。
        - 测试用例内容与被测函数无实际关联，仅起到“走流程”作用。
- **测试覆盖率要求**：确保关键功能有充分的测试覆盖
- **集成测试**：验证实际的网络访问、数据库操作等
- **使用pytest标记**：区分单元测试、集成测试和慢速测试

### 2. 错误处理策略
- **网络相关错误**：使用重试机制，最大重试次数通常为3次
- **配置错误**：在启动时就检查并报告配置问题
- **数据格式错误**：提供清晰的错误信息，便于调试
- **日志记录**：使用`lib.logger`记录重要操作和错误信息

### 3. 代码审查要点
- **API兼容性**：关注第三方库的更新，及时修复弃用API
- **性能考虑**：避免不必要的重复计算和内存占用
- **安全考虑**：敏感信息不要硬编码，使用配置文件或环境变量
- **文档完整性**：确保关键函数有完整的文档字符串

## 平台特定规范

### Windows开发环境
- **命令行语法**：使用PowerShell兼容的命令，避免Linux特有的语法如`&&`
- **路径分隔符**：使用`os.path.join()`或`pathlib`处理路径
- **换行符**：注意Windows和Linux的换行符差异

## 第三方库集成规范

### 1. 网络请求库
- **代理配置**：统一使用`lib.config.get_http_proxy()`获取代理配置
- **超时设置**：为网络请求设置合理的超时时间
- **重试机制**：对网络相关异常实施重试策略
- **错误处理**：区分网络错误、服务器错误和数据格式错误

### 2. 数据处理库
- **时间处理**：使用`lib.utils.time`中的函数处理时间字符串
- **哈希生成**：使用`lib.utils.string.hash_str()`生成哈希值
- **数据验证**：对外部数据进行必要的验证和清洗

## 具体实践案例

### DuckDuckGo搜索功能开发
这是一个完整的功能开发案例，体现了以下规范：

1. **代码复用**：使用`lib.utils.string.hash_str()`和`lib.utils.time.parse_datetime_string()`
2. **错误处理**：使用`@with_retry`装饰器处理网络异常，不隐藏其他错误
3. **数据结构**：返回统一的NewsInfo对象数组
4. **测试驱动**：编写了12个测试用例，覆盖各种场景
5. **代理配置**：集成项目统一的代理配置机制

### 经验教训
- **不要隐藏异常**：透明的错误处理有助于问题诊断
- **遵循项目规范**：使用现有工具函数保持代码一致性
- **测试是关键**：全面的测试用例确保功能稳定性
- **渐进改进**：从基础功能到错误处理优化，体现了迭代开发的价值

---

*本规范会随着项目发展持续更新，请定期查阅最新版本*